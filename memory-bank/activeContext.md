# Active Context - PDF Service Go

## Текущий фокус работы
**Завершена интеграция системы детального анализа запросов в веб-интерфейс и оптимизация стабильности сервисов**

## Недавние изменения (Август 2025)

### ✅ Реализована система детального анализа запросов
- **Новые таблицы БД**: 
  - `error_logs` - детальная информация об ошибках с stack traces
  - `request_details` - полное логирование HTTP запросов (headers, body, IP, duration)
- **Go компоненты**:
  - `RequestCaptureMiddleware` - перехват всех HTTP запросов
  - `RequestAnalysisHandler` - API для анализа запросов
  - `RequestDetail`, `RequestCapture` структуры для работы с данными
- **API endpoints для анализа**:
  - `GET /api/v1/requests/error` - список запросов с ошибками
  - `GET /api/v1/requests/analytics` - аналитика по запросам
  - `GET /api/v1/requests/:id` - детали конкретного запроса
  - `GET /api/v1/requests/:id/body` - тело запроса для анализа
- **Интегрированный веб-интерфейс**: `/dashboard` с единым просмотром ошибок и запросов

### ✅ Улучшена автоматизация Makefile
- **Убраны жестко прописанные IP**: Автоматическое определение URL сервиса
- **Централизованные переменные**: `DOCKER_MIRROR`, `DOCKER_HUB_IMAGE` для легкой смены конфигурации
- **Новые команды**:
  - `make get-service-url ENV=prod` - получение актуального URL сервиса
  - `make test-error-system ENV=prod` - комплексная проверка системы
  - `make show-mirror-usage` - показ файлов использующих зеркало
  - `make update-mirror NEW_MIRROR=...` - смена зеркала во всех файлах

### ✅ Решены проблемы развертывания
- **Docker registry workflow**: Push в Docker Hub → Sync в зеркало → Pull в кластере
- **Обратная совместимость**: Поддержка `GOTENBERG_URL` и `GOTENBERG_API_URL`
- **Принудительное обновление**: `make force-update` для проблем с синхронизацией зеркала

## Активные решения

### Архитектурные решения
- **Микросервисная архитектура** с отдельными компонентами для каждой функции
- **Event-driven error tracking** с асинхронным логированием ошибок
- **Graceful degradation** при недоступности внешних сервисов

### Технические решения
- **Structured logging** с Zap для машиночитаемых логов
- **OpenTelemetry tracing** для end-to-end видимости запросов
- **PostgreSQL для persistence** статистики и ошибок
- **Circuit breaker pattern** для устойчивости к сбоям

### Операционные решения
- **Makefile-based automation** для всех операций развертывания
- **Environment-specific configuration** через переменные и контексты
- **Health checks и probes** для Kubernetes

### ✅ Оптимизирована стабильность сервисов
- **Увеличены ресурсы**: 
  - Gotenberg: CPU 750m→1000m, Memory 1Gi→1.5Gi (requests), CPU 1500m→2000m, Memory 2Gi→3Gi (limits)
  - PostgreSQL: CPU 500m→750m, Memory 1Gi→1.5Gi (requests), CPU 1000m→1500m, Memory 2Gi→3Gi (limits)
- **Оптимизированы Health Checks**: Увеличены интервалы и количество попыток для снижения ложных рестартов
- **Настройки для NFS storage**: Специальная конфигурация PostgreSQL для стабильной работы с сетевым хранилищем
- **Решена проблема request_id**: Исправлена генерация корректных ID без символов кодировки

## Следующие шаги

### ✅ Завершено: Единый интерфейс мониторинга 
- ✅ Создан унифицированный `/dashboard` с вкладками Обзор/Статистика/Ошибки
- ✅ Интегрирован просмотр тела запросов прямо в веб-интерфейсе
- ✅ Реализованы модальные окна с деталями запросов, копированием и форматированием JSON
- ✅ Комбинированное отображение старых и новых ошибок в едином списке
- ✅ Автоматическое создание схемы БД при развертывании для production-ready решения

### Приоритет 1: Интеграции и уведомления
- Настройка Slack/email уведомлений для критических алертов
- SLA метрики и reporting дашборды
- Интеграция с внешними системами мониторинга

### Приоритет 2: Производительность
- Оптимизация обработки больших документов
- Кэширование часто используемых шаблонов
- Асинхронная обработка для длительных операций

### Приоритет 3: Безопасность
- Аутентификация и авторизация API
- Rate limiting для предотвращения abuse
- Аудит логи для compliance

## Текущие известные проблемы
- **Мониторинг рестартов**: Gotenberg и PostgreSQL периодически рестартовали, но после оптимизации ресурсов ситуация улучшилась
- **NFS storage challenges**: PostgreSQL иногда теряет lock файлы на NFS, добавлены специальные настройки для решения
- **Синхронизация зеркала**: Задержка 15-30 минут при обновлении образов

## Контекст для будущих изменений
- Система готова к горизонтальному масштабированию
- Архитектура поддерживает добавление новых типов документов
- Monitoring stack готов к расширению метрик
- Error tracking может быть интегрирован с внешними системами (Sentry, etc.)